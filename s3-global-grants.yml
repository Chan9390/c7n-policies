policies:

  - name: s3-global-access-mark
    resource: s3
    comment: |
      Find all S3 buckets with global grants, tag them for grant removal in
      1 day, and send a notification.
    filters:
      - "tag:c7n_s3_global_grants": absent
      - type: global-grants
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - type: mark-for-op
        tag: c7n_s3_global_grants
        op: delete-global-grants
        days: 1
      - type: notify
        template: default.html
        priority_header: 1
        subject: |
          "S3 bucket must be secured {{ account }}:{{ region }}"
        violation_desc: "S3 bucket has global grants."
        action_desc: |
          Offending S3 bucket marked for global grant removal in 1 day.
        to:
           - "example"
        transport:
             type: sqs
             queue: c7nMessageQueue

  - name: s3-global-access-unmark
    resource: s3
    comment: |
      Unmark any previously marked S3 bucket which no longer has global grants.
    filters:
      - "tag:c7n_s3_global_grants": not-null
      - not:
        - type: global-grants
    actions:
      - type: unmark
        tags: [c7n_s3_global_grants]
      - type: notify
        template: default.html
        priority_header: 1
        subject: |
          "S3 bucket must be secured {{ account }}:{{ region }}"
        violation_desc: "S3 bucket has global grants."
        action_desc: |
          S3 bucket(s) are no longer marked to delete global grants.
        to:
           - "example"
        transport:
             type: sqs
             queue: c7nMessageQueue

  - name: s3-remove-global-access
    resource: s3
    comment: |
      Remove global grants from S3 buckets marked for today's date.
    filters:
      - type: global-grants
      - type: marked-for-op
        tag: c7n_s3_global_grants
        op: delete-global-grants
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - type: delete-global-grants
        grantees:
          - "http://acs.amazonaws.com/groups/global/AllUsers"
          - "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
      - type: unmark
        tags: [c7n_s3_global_grants]
      - type: notify
        template: default.html
        priority_header: 1
        subject: |
          "S3 bucket must be secured {{ account }}:{{ region }}"
        violation_desc: "S3 bucket has global grants."
        action_desc: |
          S3 bucket(s) global grants have been removed.
        to:
           - "example"
        transport:
             type: sqs
             queue: c7nMessageQueue
