policies:

  - name: ec2-tag-compliance-mark
    resource: ec2
    comment: |
      Find all (non-ASG) instances that are not conformant
      to tagging policies, tag them for stoppage in 1 day.
    filters:
      - "tag:aws:autoscaling:groupName": absent
      - "tag:c7n_tag_compliance": absent
      - or:
        - "tag:data_class": absent
        - "tag:department": absent
        - "tag:division": absent
        - "tag:env": absent
        - "tag:owner": absent
        - "tag:service": absent
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - type: mark-for-op
        tag: c7n_tag_compliance
        op: stop
        days: 1

  - name: ec2-tag-compliance-unmark
    resource: ec2
    comment: |
      Any instances which have previously been marked as
      non compliant with tag policies, that are now compliant
      should be unmarked as non-compliant.
    filters:
      - "tag:aws:autoscaling:groupName": absent
      - "tag:c7n_tag_compliance": not-null
      - "tag:data_class": not-null
      - "tag:department": not-null
      - "tag:division": not-null
      - "tag:env": not-null
      - "tag:owner": not-null
      - "tag:service": not-null
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - type: unmark
        tags: [c7n_tag_compliance]

  - name: ec2-tag-compliance-stop
    resource: ec2
    comment: |
      Stop all non autoscaling group instances previously marked
      for stoppage by today's date, and schedule termination in
      2 days. Also verify that they continue to not meet tagging
      policies.
    filters:
      - "tag:aws:autoscaling:groupName": absent
      - type: marked-for-op
        tag: c7n_tag_compliance
        op: stop
      - or:
        - "tag:data_class": absent
        - "tag:department": absent
        - "tag:division": absent
        - "tag:env": absent
        - "tag:owner": absent
        - "tag:service": absent
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - stop
      - type: mark-for-op
        tag: c7n_tag_compliance
        op: terminate
        days: 3

  - name: ec2-tag-compliance-terminate
    resource: ec2
    comment: |
      Terminate all stopped instances marked for termination
      by today's date.
    filters:
      - "tag:aws:autoscaling:groupName": absent
      - type: marked-for-op
        tag: c7n_tag_compliance
        op: terminate
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - type: terminate
        force: true

  - name: ec2-tag-compliance-nag-stop
    resource: ec2
    comment: |
      Stop all instances marked for termination every hour
      starting 1 day before their termination.
    filters:
      - "tag:aws:autoscaling:groupName": absent
      - type: marked-for-op
        tag: c7n_tag_compliance
        op: terminate
        skew: 1
    mode:
      schedule: "rate(5 minutes)"
      type: periodic
    actions:
      - stop
